/*!
* plain-combobox 1.0.3
* https://github.com/premchandrasingh/plain-combobox
* Copyright 2017 @ Prem
* Contributors :- Prem <premchandrasingh@gmail.com>
* Licensed under: MIT (http://www.opensource.org/licenses/MIT)
*/

!function(e){"use strict";function t(e,t,n,o){var i=!1;return(!e||t||n)&&(i=!0),i&&n&&o&&!new RegExp(o,"i").test(n)&&(i=!1),i}e.module("pCombobox",[]).directive("pCombobox",["$window","$timeout",function(n,o){return{restrict:"E",scope:{options:"=",selected:"=",isRequired:"=?",isDisabled:"=?",name:"@",cssClass:"@",placeholder:"@",filter:"&",onSelected:"&",inputFormat:"@",onInputFormatValidate:"&"},template:'<div class="pCombobox">        <input type="text" name="{{name}}" placeholder="{{placeholder}}" autocomplete="off" ng-model="search"            class="{{cssClass}}" ng-disabled="isDisabled"            ng-required="isRequired" ng-change="events.change()" ng-focus="events.focus()" ng-blur="events.blur($event)" p-combobox-validator />            <ul ng-show="isOpen">                <li ng-repeat="item in options" ng-click="events.select(item)" ng-mouseenter="events.mouseenter($index)" ng-mousedown="events.mousedown()"                    ng-class="{\'pCombobox-active\': activeIndex === $index}">                    <span ng-if="item.readableName">{{item.readableName}}</span>                    <span ng-if="!item.readableName">{{item}}</span>                </li>            </ul></div>',controller:["$scope",function(e){e.$watch(function(){return e.selected},function(t,n){e.search=t}),this.getSelected=function(){return e.selected},this.isRequired=function(){return e.isRequired},this.getSearch=function(){return e.search}}],link:function(i,s,a,c){var r=!1;i.name=i.name||Date.now(),i.isRequired=i.isRequired||!1,i.isDisabled=i.isDisabled||!1,i.search=i.selected;i.options;i.events={change:function(){p.openPopup(),p.setActive(-1),i.selected=i.search;var t=p.checkValidation();t||(i.selected=null),i.inputFormat&&i.onInputFormatValidate&&e.isFunction(i.onInputFormatValidate())&&i.onInputFormatValidate()({isValid:t,value:i.search})},focus:function(){var e=p.findIndex(i.search);e>=0?p.setActive(e):p.setActive(-1),p.openPopup(),o(function(){p.updateDropPosition(),p.scrollToSelection()})},blur:function(){if(r)return void(r=!1);p.closePopup()},mousedown:function(){r=!0},mouseenter:function(e){p.setActive(e)},select:function(t){t=t||null,i.selected=t,i.search=t,p.closePopup(),p.checkValidation(),i.onSelected&&e.isFunction(i.onSelected())&&i.onSelected()(t)}},s.bind("keydown",function(e){switch(e.which){case 27:i.$apply(p.closePopup);break;case 38:i.$apply(p.up);break;case 40:i.$apply(p.down);break;case 13:e.preventDefault(),i.$apply(p.selectActiveItem);break;case 9:i.$apply(p.selectActiveItem)}});var l=s.find("ul"),u=s.find("input"),p={openPopup:function(){i.isOpen=!0},closePopup:function(){i.isOpen=!1,l.removeClass("pCombobox-reverse")},up:function(){if(i.isOpen){var e=i.activeIndex-1;e>=0?p.setActive(e):p.setActive(i.options.length-1)}},down:function(){if(i.isOpen){var e=i.activeIndex+1;e<i.options.length?p.setActive(e):p.setActive(0)}},setActive:function(e){i.activeIndex=e},selectActiveItem:function(){i.activeIndex>=0&&i.activeIndex<i.options.length?i.events.select(i.options[i.activeIndex]):-1===i.activeIndex&&i.events.select(i.search)},findIndex:function(e){if(!e)return-1;"string"==typeof e&&(e=e.toLowerCase());for(var t=0;t<i.options.length;t++)if("string"==typeof i.options[t]&&i.options[t].toLowerCase()===e||i.options[t]===e)return t;return-1},checkValidation:function(){var e,n=s.find("input").isolateScope();return e=n&&n.updateValidation?n.updateValidation():t(i.isRequired,i.search,i.selected,i.inputFormat),e?u.removeClass("pCombobox-invalid"):u.addClass("pCombobox-invalid"),e},updateDropPosition:function(){var e=p.offset(u[0]),t=(l[0].offsetHeight,n.innerHeight);e.top>t/2?l.addClass("pCombobox-reverse"):l.removeClass("pCombobox-reverse")},scrollToSelection:function(){o(function(){if(l&&i.activeIndex>-1){var e=l[0].querySelector(".pCombobox-active");if(e&&e.parentNode){var t=l[0].offsetHeight,n=Math.max(t/2,50);e.parentNode.scrollTop=e.offsetTop-n}}},10)},offset:function(e){if(e){var t,n,o,i;return e.getClientRects().length?(o=e.getBoundingClientRect(),t=e.ownerDocument,n=t.documentElement,i=t.defaultView,{top:o.top+i.pageYOffset-n.clientTop,left:o.left+i.pageXOffset-n.clientLeft}):{top:0,left:0}}}}}}}]),e.module("pCombobox").directive("pComboboxValidator",function(){return{require:["^pCombobox","ngModel"],restrict:"A",scope:{},link:function(e,n,o,i){var s=i[0],a=i[1];e.updateValidation=function(){var n=t(s.isRequired(),s.getSearch(),s.getSelected(),e.$parent.inputFormat);return a.$setValidity("pComboboxValid",n),n}}}})}(angular);